\hypertarget{player_8cpp_source}{\section{player.\+cpp}
\label{player_8cpp_source}\index{src/player/player.\+cpp@{src/player/player.\+cpp}}
}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of playd.}
00002 \textcolor{comment}{// playd is licenced under the MIT license: see LICENSE.txt.}
00003 
00012 \textcolor{preprocessor}{#include <cassert>}
00013 \textcolor{preprocessor}{#include <sstream>}
00014 \textcolor{preprocessor}{#include <stdexcept>}
00015 \textcolor{preprocessor}{#include <string>}
00016 
00017 \textcolor{preprocessor}{#include "../audio/audio\_system.hpp"}
00018 \textcolor{preprocessor}{#include "../audio/audio.hpp"}
00019 \textcolor{preprocessor}{#include "../errors.hpp"}
00020 \textcolor{preprocessor}{#include "../io/io\_response.hpp"}
00021 \textcolor{preprocessor}{#include "../messages.h"}
00022 \textcolor{preprocessor}{#include "\hyperlink{player__state_8hpp}{player\_state.hpp}"}
00023 \textcolor{preprocessor}{#include "\hyperlink{player_8hpp}{player.hpp}"}
00024 
\hypertarget{player_8cpp_source_l00025}{}\hyperlink{classPlayer_a19fcaf8a2864565adcde9b955a890431}{00025} \hyperlink{classPlayer_a19fcaf8a2864565adcde9b955a890431}{Player::Player}(\textcolor{keyword}{const} \hyperlink{classAudioSystem}{AudioSystem} &audio\_system, \textcolor{keyword}{const} 
      \hyperlink{classTimeParser}{Player::TP} &time\_parser)
00026     : file(audio\_system),
00027       position(),
00028       state(),
00029       time\_parser(time\_parser),
00030       end\_sink(nullptr)
00031 \{
00032 \}
00033 
\hypertarget{player_8cpp_source_l00034}{}\hyperlink{classPlayer_a91f887a024035be5030aa4b3384705fa}{00034} \textcolor{keywordtype}{bool} \hyperlink{classPlayer_a91f887a024035be5030aa4b3384705fa}{Player::Update}()
00035 \{
00036     \textcolor{keywordflow}{if} (\hyperlink{classPlayer_aa56e60cd7b83a4aa7ebda1e6ec054f4d}{CurrentStateIn}(\hyperlink{classPlayerState_aa5e7203a1fa44e8bceffe65b6ad2c554}{PlayerState::AUDIO\_PLAYING\_STATES})) \{
00037         \hyperlink{classPlayer_affe746dc330ee92b64e2093c84858625}{PlaybackUpdate}();
00038     \}
00039     \textcolor{keywordflow}{if} (\hyperlink{classPlayer_aa56e60cd7b83a4aa7ebda1e6ec054f4d}{CurrentStateIn}(\hyperlink{classPlayerState_a850bf90685a377001cfc46808cf017a4}{PlayerState::AUDIO\_LOADED\_STATES})) \{
00040         this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_afe0b43a6980e548a6faa87f84d22d65b}{Update}();
00041     \}
00042     \textcolor{keywordflow}{return} \hyperlink{classPlayer_a0688e00b9fa4699dbe15c370b2703a68}{IsRunning}();
00043 \}
00044 
\hypertarget{player_8cpp_source_l00045}{}\hyperlink{classPlayer_affe746dc330ee92b64e2093c84858625}{00045} \textcolor{keywordtype}{void} \hyperlink{classPlayer_affe746dc330ee92b64e2093c84858625}{Player::PlaybackUpdate}()
00046 \{
00047     \textcolor{keywordflow}{if} (this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_a43d903e65213d3a6b2c8b38924c83c5f}{IsStopped}()) \{
00048         \textcolor{keywordflow}{if} (this->\hyperlink{classPlayer_aa6e6da38e67a266350452cfbc6d8341b}{end\_sink} != \textcolor{keyword}{nullptr}) \{
00049             this->\hyperlink{classPlayer_aa6e6da38e67a266350452cfbc6d8341b}{end\_sink}->\hyperlink{classResponseSink_ac2add6144c2804a6f0db34ad30046ed7}{Respond}(\hyperlink{io__response_8hpp_af5828b68a5f305a17b90321710d9b546ab1a326c06d88bf042f73d70f50197905}{ResponseCode::END}, \textcolor{stringliteral}{""});
00050         \}
00051         \hyperlink{classPlayer_abe074115b0ffa631ea432a1b84171599}{Stop}();
00052         \hyperlink{classPlayer_a873c7e0a5be71efbadeebfbc20d7448a}{Seek}(\textcolor{stringliteral}{"0"});
00053     \} \textcolor{keywordflow}{else} \{
00054         \hyperlink{classPlayer_aa055a70690c66e3fd9949358fccadd5c}{UpdatePosition}();
00055     \}
00056 \}
00057 
\hypertarget{player_8cpp_source_l00058}{}\hyperlink{classPlayer_aac35c9a49758150d5c5e0ea2fcd94d16}{00058} \textcolor{keywordtype}{void} \hyperlink{classPlayer_aac35c9a49758150d5c5e0ea2fcd94d16}{Player::WelcomeClient}(\hyperlink{classResponseSink}{ResponseSink} &client)\textcolor{keyword}{ const}
00059 \textcolor{keyword}{}\{
00060     client.\hyperlink{classResponseSink_ac2add6144c2804a6f0db34ad30046ed7}{Respond}(\hyperlink{io__response_8hpp_af5828b68a5f305a17b90321710d9b546a578a88371503e8fd23725bd3a684ed9e}{ResponseCode::OHAI}, \hyperlink{messages_8h_a58fd26477b5defa3dbdde5efbe862c21}{MSG\_OHAI});
00061     client.\hyperlink{classResponseSink_ac2add6144c2804a6f0db34ad30046ed7}{Respond}(\hyperlink{io__response_8hpp_af5828b68a5f305a17b90321710d9b546ab1fa6b4767532c2e890022101221bd08}{ResponseCode::FEATURES}, 
      \hyperlink{messages_8h_a29759ce3d7805e029d83ab11195e6bf9}{MSG\_FEATURES});
00062     this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_a00f044c74d07d778532953a917c24197}{Emit}(client);
00063     this->\hyperlink{classPlayer_a7b0a4ce9f2ebf3d1e026cf3e0ee61152}{position}.\hyperlink{classPlayerPosition_a66963c28fd9dffe0fd7338023310fa92}{Emit}(client);
00064     this->\hyperlink{classPlayer_afb60fdad921bce05783ef2709e849c27}{state}.\hyperlink{classPlayerState_aa93a9879688bfbd3d89ac102c079cbfd}{Emit}(client);
00065 \}
00066 
\hypertarget{player_8cpp_source_l00067}{}\hyperlink{classPlayer_a719de5af4d1534c2d805a19d5d995deb}{00067} \textcolor{keywordtype}{void} \hyperlink{classPlayer_a719de5af4d1534c2d805a19d5d995deb}{Player::SetResponseSink}(\hyperlink{classResponseSink}{ResponseSink} &sink)
00068 \{
00069     this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classResponseSource_a12c45136716adffa59d5e5e1ca80b7ce}{SetResponseSink}(sink);
00070     this->\hyperlink{classPlayer_a7b0a4ce9f2ebf3d1e026cf3e0ee61152}{position}.\hyperlink{classResponseSource_a12c45136716adffa59d5e5e1ca80b7ce}{SetResponseSink}(sink);
00071     this->\hyperlink{classPlayer_afb60fdad921bce05783ef2709e849c27}{state}.\hyperlink{classResponseSource_a12c45136716adffa59d5e5e1ca80b7ce}{SetResponseSink}(sink);
00072     this->\hyperlink{classPlayer_aa6e6da38e67a266350452cfbc6d8341b}{end\_sink} = &sink;
00073 \}
00074 
00075 \textcolor{comment}{//}
00076 \textcolor{comment}{// Commands}
00077 \textcolor{comment}{//}
00078 
\hypertarget{player_8cpp_source_l00079}{}\hyperlink{classPlayer_ac93a5310c751e8a9221780933f7a9dd6}{00079} \textcolor{keywordtype}{bool} \hyperlink{classPlayer_ac93a5310c751e8a9221780933f7a9dd6}{Player::Eject}()
00080 \{
00081     \textcolor{keywordflow}{if} (\hyperlink{classPlayer_aa56e60cd7b83a4aa7ebda1e6ec054f4d}{CurrentStateIn}(\hyperlink{classPlayerState_a850bf90685a377001cfc46808cf017a4}{PlayerState::AUDIO\_LOADED\_STATES})) \{
00082         this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_a394b2e7b4f4d0baee4ff1928a36e9945}{Eject}();
00083         \hyperlink{classPlayer_a92807b30e89ece50e94dac493ee56b51}{SetState}(\hyperlink{classPlayerState_ab013f68ff23d69d677faae624b5dff07a209d5541434371bb6b79dc8cca8fa55b}{PlayerState::State::EJECTED});
00084         \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00085     \}
00086     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00087 \}
00088 
\hypertarget{player_8cpp_source_l00089}{}\hyperlink{classPlayer_a41c5eccb1f3b86383eaafe56a40a60e0}{00089} \textcolor{keywordtype}{bool} \hyperlink{classPlayer_a41c5eccb1f3b86383eaafe56a40a60e0}{Player::Load}(\textcolor{keyword}{const} std::string &path)
00090 \{
00091     \textcolor{keywordtype}{bool} valid = !path.empty();
00092     \textcolor{keywordflow}{if} (valid) \{
00093         \textcolor{keywordflow}{try}
00094         \{
00095             this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_a92dd004d4ab034bf41f7d5c76847d3c2}{Load}(path);
00096             \hyperlink{classPlayer_a66e226836bf4d6cd206716caeb232094}{ResetPosition}();
00097             \hyperlink{classPlayer_a92807b30e89ece50e94dac493ee56b51}{SetState}(\hyperlink{classPlayerState_ab013f68ff23d69d677faae624b5dff07a09d4d696b4e935115b9313e3c412509a}{PlayerState::State::STOPPED});
00098         \}
00099         \textcolor{keywordflow}{catch} (\hyperlink{classFileError}{FileError} &)
00100         \{
00101             \textcolor{comment}{// File errors aren't fatal, so catch them here.}
00102             \hyperlink{classPlayer_ac93a5310c751e8a9221780933f7a9dd6}{Eject}();
00103             valid = \textcolor{keyword}{false};
00104         \}
00105         \textcolor{keywordflow}{catch} (\hyperlink{classError}{Error} &)
00106         \{
00107             \textcolor{comment}{// Ensure a load failure doesn't leave a corrupted track}
00108             \textcolor{comment}{// loaded.}
00109             \hyperlink{classPlayer_ac93a5310c751e8a9221780933f7a9dd6}{Eject}();
00110             \textcolor{keywordflow}{throw};
00111         \}
00112     \}
00113     \textcolor{keywordflow}{return} valid;
00114 \}
00115 
\hypertarget{player_8cpp_source_l00116}{}\hyperlink{classPlayer_a1df3950102f682608482042cdea96598}{00116} \textcolor{keywordtype}{bool} \hyperlink{classPlayer_a1df3950102f682608482042cdea96598}{Player::Play}()
00117 \{
00118     \textcolor{keywordflow}{if} (\hyperlink{classPlayer_aa56e60cd7b83a4aa7ebda1e6ec054f4d}{CurrentStateIn}(\{ \hyperlink{classPlayerState_ab013f68ff23d69d677faae624b5dff07a09d4d696b4e935115b9313e3c412509a}{PlayerState::State::STOPPED} \})) \{
00119         this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_a426f8ad29efd5e16ac7963354087d070}{Start}();
00120         \hyperlink{classPlayer_a92807b30e89ece50e94dac493ee56b51}{SetState}(\hyperlink{classPlayerState_ab013f68ff23d69d677faae624b5dff07a50366a49630a416ab3ccaa004196027e}{PlayerState::State::PLAYING});
00121         \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00122     \}
00123     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00124 \}
00125 
\hypertarget{player_8cpp_source_l00126}{}\hyperlink{classPlayer_a7d5c0535d543b358b6deecb054565b97}{00126} \textcolor{keywordtype}{bool} \hyperlink{classPlayer_a7d5c0535d543b358b6deecb054565b97}{Player::Quit}()
00127 \{
00128     \hyperlink{classPlayer_ac93a5310c751e8a9221780933f7a9dd6}{Eject}();
00129     \hyperlink{classPlayer_a92807b30e89ece50e94dac493ee56b51}{SetState}(\hyperlink{classPlayerState_ab013f68ff23d69d677faae624b5dff07a4eb3979af877a3c13830cd69c746e230}{PlayerState::State::QUITTING});
00130 
00131     \textcolor{keywordflow}{return} \textcolor{keyword}{true}; \textcolor{comment}{// Always a valid command.}
00132 \}
00133 
\hypertarget{player_8cpp_source_l00134}{}\hyperlink{classPlayer_a873c7e0a5be71efbadeebfbc20d7448a}{00134} \textcolor{keywordtype}{bool} \hyperlink{classPlayer_a873c7e0a5be71efbadeebfbc20d7448a}{Player::Seek}(\textcolor{keyword}{const} std::string &time\_str)
00135 \{
00136     \textcolor{keywordflow}{if} (\hyperlink{classPlayer_aa56e60cd7b83a4aa7ebda1e6ec054f4d}{CurrentStateIn}(\hyperlink{classPlayerState_a850bf90685a377001cfc46808cf017a4}{PlayerState::AUDIO\_LOADED\_STATES})) \{
00137         \textcolor{keywordtype}{bool} success = \textcolor{keyword}{true};
00138         std::chrono::microseconds \hyperlink{classPlayer_a7b0a4ce9f2ebf3d1e026cf3e0ee61152}{position}(0);
00139 
00140         \textcolor{keywordflow}{try}
00141         \{
00142             position = this->\hyperlink{classPlayer_ad7c6ccd4156c01d419825abe6704fca7}{time\_parser}.\hyperlink{classTimeParser_a68110dc8c7d2ad1a8f47a29646ad4d1c}{Parse}(time\_str);
00143         \}
00144         \textcolor{keywordflow}{catch} (std::out\_of\_range)
00145         \{
00146             success = \textcolor{keyword}{false};
00147         \}
00148 
00149         \textcolor{keywordflow}{if} (success) \{
00150             this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_a8c270134404d83fe6c9e844abeacf3e5}{SeekToPosition}(position);
00151             this->\hyperlink{classPlayer_a66e226836bf4d6cd206716caeb232094}{ResetPosition}();
00152             this->\hyperlink{classPlayer_aa055a70690c66e3fd9949358fccadd5c}{UpdatePosition}();
00153         \}
00154         \textcolor{keywordflow}{return} success;
00155     \}
00156     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00157 \}
00158 
\hypertarget{player_8cpp_source_l00159}{}\hyperlink{classPlayer_abe074115b0ffa631ea432a1b84171599}{00159} \textcolor{keywordtype}{bool} \hyperlink{classPlayer_abe074115b0ffa631ea432a1b84171599}{Player::Stop}()
00160 \{
00161     \textcolor{keywordflow}{if} (\hyperlink{classPlayer_aa56e60cd7b83a4aa7ebda1e6ec054f4d}{CurrentStateIn}(\hyperlink{classPlayerState_aa5e7203a1fa44e8bceffe65b6ad2c554}{PlayerState::AUDIO\_PLAYING\_STATES})) \{
00162         this->\hyperlink{classPlayer_abcb788a7830c40ae5ba2a219c5341a58}{file}.\hyperlink{classPlayerFile_afd4313009b5d51df0df5dc7b59ffcf13}{Stop}();
00163         \hyperlink{classPlayer_a92807b30e89ece50e94dac493ee56b51}{SetState}(\hyperlink{classPlayerState_ab013f68ff23d69d677faae624b5dff07a09d4d696b4e935115b9313e3c412509a}{PlayerState::State::STOPPED});
00164         \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00165     \}
00166     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00167 \}
\end{DoxyCode}
