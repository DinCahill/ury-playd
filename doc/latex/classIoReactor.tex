\hypertarget{classIoReactor}{\section{Io\+Reactor Class Reference}
\label{classIoReactor}\index{Io\+Reactor@{Io\+Reactor}}
}


The I\+O reactor, which services input, routes responses, and executes the \hyperlink{classPlayer}{Player} update routine periodically.  




{\ttfamily \#include $<$io\+\_\+reactor.\+hpp$>$}



Inheritance diagram for Io\+Reactor\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=165pt]{classIoReactor__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for Io\+Reactor\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classIoReactor__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classIoReactor_aace954427c447c73caf6b8dbcd367284}{Io\+Reactor} (\hyperlink{classPlayer}{Player} \&\hyperlink{classIoReactor_a795397b36da55b59bff63b455a344dea}{player}, \hyperlink{classCommandHandler}{Command\+Handler} \&\hyperlink{classIoReactor_a81bf838edb7adf1edcb992bfe61d6b78}{handler}, const std\+::string \&address, const std\+::string \&port)
\begin{DoxyCompactList}\small\item\em Constructs an \hyperlink{classIoReactor}{Io\+Reactor}. \end{DoxyCompactList}\item 
\hypertarget{classIoReactor_a5b0292192e98a5e6e0fcd65631b3e0fe}{\hyperlink{classIoReactor_a5b0292192e98a5e6e0fcd65631b3e0fe}{Io\+Reactor} (const \hyperlink{classIoReactor}{Io\+Reactor} \&)=delete}\label{classIoReactor_a5b0292192e98a5e6e0fcd65631b3e0fe}

\begin{DoxyCompactList}\small\item\em Deleted copy constructor. \end{DoxyCompactList}\item 
\hypertarget{classIoReactor_a5e05bcbdf86f3124adb67ce76bf4f8a9}{\hyperlink{classIoReactor}{Io\+Reactor} \& \hyperlink{classIoReactor_a5e05bcbdf86f3124adb67ce76bf4f8a9}{operator=} (const \hyperlink{classIoReactor}{Io\+Reactor} \&)=delete}\label{classIoReactor_a5e05bcbdf86f3124adb67ce76bf4f8a9}

\begin{DoxyCompactList}\small\item\em Deleted copy-\/assignment. \end{DoxyCompactList}\item 
void \hyperlink{classIoReactor_a23f583f9964a6f3f38f983b40f7ae10d}{Run} ()
\begin{DoxyCompactList}\small\item\em Runs the reactor. \end{DoxyCompactList}\item 
void \hyperlink{classIoReactor_a3566c7200adb102579d2c330a2cbf91d}{End} ()
\begin{DoxyCompactList}\small\item\em Ends the reactor. \end{DoxyCompactList}\item 
void \hyperlink{classIoReactor_a535c6ff0899391afc02c87b1dfe7c6e2}{New\+Connection} (uv\+\_\+stream\+\_\+t $\ast$\hyperlink{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{server})
\begin{DoxyCompactList}\small\item\em Accepts a new connection. \end{DoxyCompactList}\item 
void \hyperlink{classIoReactor_af31bb722acf08d10eaa46ea7a1a5d4ca}{Remove\+Connection} (\hyperlink{classTcpResponseSink}{Tcp\+Response\+Sink} \&sink)
\begin{DoxyCompactList}\small\item\em Removes a connection. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Private Member Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{classIoReactor_a4cfe12db93bda3f7b2c29436c4969006}{Respond\+Raw} (const std\+::string \&string) const override
\begin{DoxyCompactList}\small\item\em Outputs a raw response string. \end{DoxyCompactList}\item 
void \hyperlink{classIoReactor_aab8269bf4512c4c74a56998898b3144e}{Init\+Acceptor} (const std\+::string \&address, const std\+::string \&port)
\begin{DoxyCompactList}\small\item\em Initialises a T\+C\+P acceptor on the given address and port. \end{DoxyCompactList}\item 
\hypertarget{classIoReactor_a8a586b8e9545e79db8dc9bca3657388f}{void \hyperlink{classIoReactor_a8a586b8e9545e79db8dc9bca3657388f}{Do\+Update\+Timer} ()}\label{classIoReactor_a8a586b8e9545e79db8dc9bca3657388f}

\begin{DoxyCompactList}\small\item\em Sets up a periodic timer to run the playd update loop. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Private Attributes}
\begin{DoxyCompactItemize}
\item 
\hypertarget{classIoReactor_a15617cf44d3c50d5c2d31e8b1812e140}{std\+::set$<$ std\+::shared\+\_\+ptr\\*
$<$ \hyperlink{classTcpResponseSink}{Tcp\+Response\+Sink} $>$ $>$ \hyperlink{classIoReactor_a15617cf44d3c50d5c2d31e8b1812e140}{connections}}\label{classIoReactor_a15617cf44d3c50d5c2d31e8b1812e140}

\begin{DoxyCompactList}\small\item\em The set of connections currently serviced by the \hyperlink{classIoReactor}{Io\+Reactor}. \end{DoxyCompactList}\item 
\hypertarget{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{uv\+\_\+tcp\+\_\+t \hyperlink{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{server}}\label{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}

\begin{DoxyCompactList}\small\item\em The libuv handle for the T\+C\+P server. \end{DoxyCompactList}\item 
\hypertarget{classIoReactor_a6364acb721e4a7a1374070e317074bbc}{uv\+\_\+timer\+\_\+t \hyperlink{classIoReactor_a6364acb721e4a7a1374070e317074bbc}{updater}}\label{classIoReactor_a6364acb721e4a7a1374070e317074bbc}

\begin{DoxyCompactList}\small\item\em The libuv handle for the update timer. \end{DoxyCompactList}\item 
\hypertarget{classIoReactor_a795397b36da55b59bff63b455a344dea}{\hyperlink{classPlayer}{Player} \& \hyperlink{classIoReactor_a795397b36da55b59bff63b455a344dea}{player}}\label{classIoReactor_a795397b36da55b59bff63b455a344dea}

\begin{DoxyCompactList}\small\item\em The player. \end{DoxyCompactList}\item 
\hypertarget{classIoReactor_a81bf838edb7adf1edcb992bfe61d6b78}{\hyperlink{classCommandHandler}{Command\+Handler} \& \hyperlink{classIoReactor_a81bf838edb7adf1edcb992bfe61d6b78}{handler}}\label{classIoReactor_a81bf838edb7adf1edcb992bfe61d6b78}

\begin{DoxyCompactList}\small\item\em The command handler. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Static Private Attributes}
\begin{DoxyCompactItemize}
\item 
\hypertarget{classIoReactor_a1d8cc56deaa2e801347c21e6490d4f5c}{static const uint16\+\_\+t \hyperlink{classIoReactor_a1d8cc56deaa2e801347c21e6490d4f5c}{P\+L\+A\+Y\+E\+R\+\_\+\+U\+P\+D\+A\+T\+E\+\_\+\+P\+E\+R\+I\+O\+D} = 5}\label{classIoReactor_a1d8cc56deaa2e801347c21e6490d4f5c}

\begin{DoxyCompactList}\small\item\em The period between player updates. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Additional Inherited Members}


\subsection{Detailed Description}
The I\+O reactor, which services input, routes responses, and executes the \hyperlink{classPlayer}{Player} update routine periodically. 

Definition at line \hyperlink{io__reactor_8hpp_source_l00035}{35} of file \hyperlink{io__reactor_8hpp_source}{io\+\_\+reactor.\+hpp}.



\subsection{Constructor \& Destructor Documentation}
\hypertarget{classIoReactor_aace954427c447c73caf6b8dbcd367284}{\index{Io\+Reactor@{Io\+Reactor}!Io\+Reactor@{Io\+Reactor}}
\index{Io\+Reactor@{Io\+Reactor}!Io\+Reactor@{Io\+Reactor}}
\subsubsection[{Io\+Reactor}]{\setlength{\rightskip}{0pt plus 5cm}Io\+Reactor\+::\+Io\+Reactor (
\begin{DoxyParamCaption}
\item[{{\bf Player} \&}]{player, }
\item[{{\bf Command\+Handler} \&}]{handler, }
\item[{const std\+::string \&}]{address, }
\item[{const std\+::string \&}]{port}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [explicit]}}}\label{classIoReactor_aace954427c447c73caf6b8dbcd367284}


Constructs an \hyperlink{classIoReactor}{Io\+Reactor}. 


\begin{DoxyParams}{Parameters}
{\em player} & The player to which periodic update requests shall be sent. \\
\hline
{\em handler} & The handler to which command inputs shall be sent. \\
\hline
{\em address} & The address to which \hyperlink{classIoReactor}{Io\+Reactor} will bind. \\
\hline
{\em port} & The port on which \hyperlink{classIoReactor}{Io\+Reactor} will listen for clients. \\
\hline
\end{DoxyParams}


Definition at line \hyperlink{io__reactor_8cpp_source_l00138}{138} of file \hyperlink{io__reactor_8cpp_source}{io\+\_\+reactor.\+cpp}.



References \hyperlink{io__reactor_8cpp_source_l00151}{Do\+Update\+Timer()}, and \hyperlink{io__reactor_8cpp_source_l00159}{Init\+Acceptor()}.


\begin{DoxyCode}
00140     : \hyperlink{classIoReactor_a795397b36da55b59bff63b455a344dea}{player}(player), \hyperlink{classIoReactor_a81bf838edb7adf1edcb992bfe61d6b78}{handler}(handler)
00141 \{
00142     \hyperlink{classIoReactor_aab8269bf4512c4c74a56998898b3144e}{InitAcceptor}(address, port);
00143     \hyperlink{classIoReactor_a8a586b8e9545e79db8dc9bca3657388f}{DoUpdateTimer}();
00144 \}
\end{DoxyCode}


\subsection{Member Function Documentation}
\hypertarget{classIoReactor_a3566c7200adb102579d2c330a2cbf91d}{\index{Io\+Reactor@{Io\+Reactor}!End@{End}}
\index{End@{End}!Io\+Reactor@{Io\+Reactor}}
\subsubsection[{End}]{\setlength{\rightskip}{0pt plus 5cm}void Io\+Reactor\+::\+End (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classIoReactor_a3566c7200adb102579d2c330a2cbf91d}


Ends the reactor. 

This should be called by the parent object when the player is quitting. 

Definition at line \hyperlink{io__reactor_8cpp_source_l00183}{183} of file \hyperlink{io__reactor_8cpp_source}{io\+\_\+reactor.\+cpp}.


\begin{DoxyCode}
00184 \{
00185     uv\_stop(uv\_default\_loop());
00186 \}
\end{DoxyCode}
\hypertarget{classIoReactor_aab8269bf4512c4c74a56998898b3144e}{\index{Io\+Reactor@{Io\+Reactor}!Init\+Acceptor@{Init\+Acceptor}}
\index{Init\+Acceptor@{Init\+Acceptor}!Io\+Reactor@{Io\+Reactor}}
\subsubsection[{Init\+Acceptor}]{\setlength{\rightskip}{0pt plus 5cm}void Io\+Reactor\+::\+Init\+Acceptor (
\begin{DoxyParamCaption}
\item[{const std\+::string \&}]{address, }
\item[{const std\+::string \&}]{port}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [private]}}}\label{classIoReactor_aab8269bf4512c4c74a56998898b3144e}


Initialises a T\+C\+P acceptor on the given address and port. 


\begin{DoxyParams}{Parameters}
{\em address} & The I\+Pv4 address on which the T\+C\+P server should listen. \\
\hline
{\em port} & The T\+C\+P port on which the T\+C\+P server should listen. \\
\hline
\end{DoxyParams}


Definition at line \hyperlink{io__reactor_8cpp_source_l00159}{159} of file \hyperlink{io__reactor_8cpp_source}{io\+\_\+reactor.\+cpp}.



References \hyperlink{io__reactor_8hpp_source_l00101}{server}, and \hyperlink{io__reactor_8cpp_source_l00082}{Uv\+Listen\+Callback()}.



Referenced by \hyperlink{io__reactor_8cpp_source_l00138}{Io\+Reactor()}.


\begin{DoxyCode}
00161 \{
00162     \textcolor{keywordtype}{int} uport = std::stoi(port);
00163 
00164     uv\_tcp\_init(uv\_default\_loop(), &this->\hyperlink{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{server});
00165     this->\hyperlink{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{server}.data = \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{void} *\textcolor{keyword}{>}(\textcolor{keyword}{this});
00166 
00167     \textcolor{keyword}{struct }sockaddr\_in bind\_addr;
00168     uv\_ip4\_addr(address.c\_str(), uport, &bind\_addr);
00169     uv\_tcp\_bind(&this->\hyperlink{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{server}, (\textcolor{keyword}{const} sockaddr *)&bind\_addr, 0);
00170 
00171     \textcolor{comment}{// TODO: Handle errors from uv\_listen.}
00172     uv\_listen((uv\_stream\_t *)&this->\hyperlink{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{server}, 128, \hyperlink{io__reactor_8cpp_ab1a411534cf6420d24748b0e78927ebf}{UvListenCallback});
00173     \hyperlink{classDebug}{Debug}() << \textcolor{stringliteral}{"Listening at"} << address << \textcolor{stringliteral}{"on"} << port << std::endl;
00174 \}
\end{DoxyCode}
\hypertarget{classIoReactor_a535c6ff0899391afc02c87b1dfe7c6e2}{\index{Io\+Reactor@{Io\+Reactor}!New\+Connection@{New\+Connection}}
\index{New\+Connection@{New\+Connection}!Io\+Reactor@{Io\+Reactor}}
\subsubsection[{New\+Connection}]{\setlength{\rightskip}{0pt plus 5cm}void Io\+Reactor\+::\+New\+Connection (
\begin{DoxyParamCaption}
\item[{uv\+\_\+stream\+\_\+t $\ast$}]{server}
\end{DoxyParamCaption}
)}}\label{classIoReactor_a535c6ff0899391afc02c87b1dfe7c6e2}


Accepts a new connection. 

This accepts the connection, and adds it to this \hyperlink{classIoReactor}{Io\+Reactor}'s connection pool.

This should be called with a server that has just received a new connection.


\begin{DoxyParams}{Parameters}
{\em server} & Pointer to the libuv server accepting connections.\\
\hline
\end{DoxyParams}
\begin{DoxyRefDesc}{Todo}
\item[\hyperlink{todo__todo000004}{Todo}]This isn't a great fit for the public interface of \hyperlink{classIoReactor}{Io\+Reactor} -\/ separate into a Connection\+Pool class? \end{DoxyRefDesc}


Definition at line \hyperlink{io__reactor_8cpp_source_l00114}{114} of file \hyperlink{io__reactor_8cpp_source}{io\+\_\+reactor.\+cpp}.



References \hyperlink{io__reactor_8hpp_source_l00096}{connections}, \hyperlink{io__reactor_8hpp_source_l00105}{handler}, \hyperlink{io__reactor_8hpp_source_l00104}{player}, \hyperlink{io__reactor_8cpp_source_l00058}{Uv\+Alloc()}, \hyperlink{io__reactor_8cpp_source_l00064}{Uv\+Close\+Callback()}, \hyperlink{io__reactor_8cpp_source_l00075}{Uv\+Read\+Callback()}, and \hyperlink{player_8cpp_source_l00058}{Player\+::\+Welcome\+Client()}.



Referenced by \hyperlink{io__reactor_8cpp_source_l00082}{Uv\+Listen\+Callback()}.


\begin{DoxyCode}
00115 \{
00116     uv\_tcp\_t *client = \textcolor{keyword}{new} uv\_tcp\_t();
00117     uv\_tcp\_init(uv\_default\_loop(), client);
00118 
00119     \textcolor{keywordflow}{if} (uv\_accept(\hyperlink{classIoReactor_a4c9c61af246fda7db1bdd4e2b3170c66}{server}, (uv\_stream\_t *)client) == 0) \{
00120         \hyperlink{classDebug}{Debug}() << \textcolor{stringliteral}{"New connection"} << std::endl;
00121         \textcolor{keyword}{auto} tcp = std::make\_shared<TcpResponseSink>(*\textcolor{keyword}{this}, client,
00122                                                      this->\hyperlink{classIoReactor_a81bf838edb7adf1edcb992bfe61d6b78}{handler});
00123         this->\hyperlink{classIoReactor_a795397b36da55b59bff63b455a344dea}{player}.\hyperlink{classPlayer_aac35c9a49758150d5c5e0ea2fcd94d16}{WelcomeClient}(*tcp);
00124         this->\hyperlink{classIoReactor_a15617cf44d3c50d5c2d31e8b1812e140}{connections}.insert(tcp);
00125         client->data = \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{void} *\textcolor{keyword}{>}(tcp.get());
00126 
00127         uv\_read\_start((uv\_stream\_t *)client, \hyperlink{io__reactor_8cpp_ab0c51a1d8447db72e81a13d45448b85f}{UvAlloc}, \hyperlink{io__reactor_8cpp_a8c1937e7aebd228e6a5eab19f1add9f9}{UvReadCallback});
00128     \} \textcolor{keywordflow}{else} \{
00129         uv\_close((uv\_handle\_t *)client, \hyperlink{io__reactor_8cpp_ab85791c3e9c737453047decfbb7388f4}{UvCloseCallback});
00130     \}
00131 \}
\end{DoxyCode}
\hypertarget{classIoReactor_af31bb722acf08d10eaa46ea7a1a5d4ca}{\index{Io\+Reactor@{Io\+Reactor}!Remove\+Connection@{Remove\+Connection}}
\index{Remove\+Connection@{Remove\+Connection}!Io\+Reactor@{Io\+Reactor}}
\subsubsection[{Remove\+Connection}]{\setlength{\rightskip}{0pt plus 5cm}void Io\+Reactor\+::\+Remove\+Connection (
\begin{DoxyParamCaption}
\item[{{\bf Tcp\+Response\+Sink} \&}]{sink}
\end{DoxyParamCaption}
)}}\label{classIoReactor_af31bb722acf08d10eaa46ea7a1a5d4ca}


Removes a connection. 


\begin{DoxyParams}{Parameters}
{\em sink} & The connection to remove.\\
\hline
\end{DoxyParams}
\begin{DoxyRefDesc}{Todo}
\item[\hyperlink{todo__todo000005}{Todo}]Rename sink? 

This isn't a great fit for the public interface of \hyperlink{classIoReactor}{Io\+Reactor} -\/ separate into a Connection\+Pool class? \end{DoxyRefDesc}


Definition at line \hyperlink{io__reactor_8cpp_source_l00133}{133} of file \hyperlink{io__reactor_8cpp_source}{io\+\_\+reactor.\+cpp}.



References \hyperlink{io__reactor_8hpp_source_l00096}{connections}.



Referenced by \hyperlink{io__reactor_8cpp_source_l00230}{Tcp\+Response\+Sink\+::\+Close()}.


\begin{DoxyCode}
00134 \{
00135     this->\hyperlink{classIoReactor_a15617cf44d3c50d5c2d31e8b1812e140}{connections}.erase(std::make\_shared<TcpResponseSink>(conn));
00136 \}
\end{DoxyCode}
\hypertarget{classIoReactor_a4cfe12db93bda3f7b2c29436c4969006}{\index{Io\+Reactor@{Io\+Reactor}!Respond\+Raw@{Respond\+Raw}}
\index{Respond\+Raw@{Respond\+Raw}!Io\+Reactor@{Io\+Reactor}}
\subsubsection[{Respond\+Raw}]{\setlength{\rightskip}{0pt plus 5cm}void Io\+Reactor\+::\+Respond\+Raw (
\begin{DoxyParamCaption}
\item[{const std\+::string \&}]{string}
\end{DoxyParamCaption}
) const\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [private]}, {\ttfamily [virtual]}}}\label{classIoReactor_a4cfe12db93bda3f7b2c29436c4969006}


Outputs a raw response string. 


\begin{DoxyParams}{Parameters}
{\em string} & The response string, of the form \char`\"{}\+C\+O\+D\+E message\char`\"{}. \\
\hline
\end{DoxyParams}


Implements \hyperlink{classResponseSink_a128a514e39f23f2bcc97fea62e9de3c5}{Response\+Sink}.



Definition at line \hyperlink{io__reactor_8cpp_source_l00176}{176} of file \hyperlink{io__reactor_8cpp_source}{io\+\_\+reactor.\+cpp}.



References \hyperlink{io__reactor_8hpp_source_l00096}{connections}.


\begin{DoxyCode}
00177 \{
00178     \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto} &conn : this->\hyperlink{classIoReactor_a15617cf44d3c50d5c2d31e8b1812e140}{connections}) \{
00179         conn->RespondRaw(\textcolor{keywordtype}{string});
00180     \}
00181 \}
\end{DoxyCode}
\hypertarget{classIoReactor_a23f583f9964a6f3f38f983b40f7ae10d}{\index{Io\+Reactor@{Io\+Reactor}!Run@{Run}}
\index{Run@{Run}!Io\+Reactor@{Io\+Reactor}}
\subsubsection[{Run}]{\setlength{\rightskip}{0pt plus 5cm}void Io\+Reactor\+::\+Run (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classIoReactor_a23f583f9964a6f3f38f983b40f7ae10d}


Runs the reactor. 

It will block until terminated. 

Definition at line \hyperlink{io__reactor_8cpp_source_l00146}{146} of file \hyperlink{io__reactor_8cpp_source}{io\+\_\+reactor.\+cpp}.


\begin{DoxyCode}
00147 \{
00148     uv\_run(uv\_default\_loop(), UV\_RUN\_DEFAULT);
00149 \}
\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
src/io/\hyperlink{io__reactor_8hpp}{io\+\_\+reactor.\+hpp}\item 
src/io/\hyperlink{io__reactor_8cpp}{io\+\_\+reactor.\+cpp}\end{DoxyCompactItemize}
