\hypertarget{audio__source_8cpp_source}{\section{audio\+\_\+source.\+cpp}
\label{audio__source_8cpp_source}\index{src/audio/audio\+\_\+source.\+cpp@{src/audio/audio\+\_\+source.\+cpp}}
}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of playd.}
00002 \textcolor{comment}{// playd is licenced under the MIT license: see LICENSE.txt.}
00003 
00010 \textcolor{preprocessor}{#include <cassert>}
00011 \textcolor{preprocessor}{#include <cstdint>}
00012 \textcolor{preprocessor}{#include <cstdlib>}
00013 \textcolor{preprocessor}{#include <functional>}
00014 \textcolor{preprocessor}{#include <iostream>}
00015 \textcolor{preprocessor}{#include <map>}
00016 \textcolor{preprocessor}{#include <memory>}
00017 \textcolor{preprocessor}{#include <sstream>}
00018 \textcolor{preprocessor}{#include <string>}
00019 
00020 \textcolor{comment}{// libsox}
00021 \textcolor{keyword}{extern} \textcolor{stringliteral}{"C"} \{
00022 \textcolor{preprocessor}{#include <sox.h>}
00023 \}
00024 
00025 \textcolor{preprocessor}{#include "../errors.hpp"}
00026 \textcolor{preprocessor}{#include "../messages.h"}
00027 \textcolor{preprocessor}{#include "../sample\_formats.hpp"}
00028 \textcolor{preprocessor}{#include "\hyperlink{audio__source_8hpp}{audio\_source.hpp}"}
00029 
00030 \textcolor{comment}{// This value is somewhat arbitrary, but corresponds to the minimum buffer size}
00031 \textcolor{comment}{// used by ffmpeg, so it's probably sensible.}
00032 \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \hyperlink{classAudioSource_a9c269c8d9c633bcd11d596c1ba3fd575}{AudioSource::BUFFER\_SIZE} = 16384;
00033 
\hypertarget{audio__source_8cpp_source_l00034}{}\hyperlink{classAudioSource_abcb925739a649c30663385a15d83af26}{00034} \hyperlink{classAudioSource_abcb925739a649c30663385a15d83af26}{AudioSource::AudioSource}(\textcolor{keyword}{const} std::string &path)
00035     : buffer(BUFFER\_SIZE), context(nullptr)
00036 \{
00037     \hyperlink{classAudioSource_a9b10234d7c9f29b17008b4dc3eab2a71}{Open}(path);
00038 \}
00039 
\hypertarget{audio__source_8cpp_source_l00040}{}\hyperlink{classAudioSource_a4d4b2be34ec676bf01d1ca1784f79a07}{00040} \hyperlink{classAudioSource_a4d4b2be34ec676bf01d1ca1784f79a07}{AudioSource::~AudioSource}()
00041 \{
00042     \hyperlink{classAudioSource_a46444de950d02ac35a695ad167fed2f4}{Close}();
00043 \}
00044 
\hypertarget{audio__source_8cpp_source_l00045}{}\hyperlink{classAudioSource_aea5c3828f1b22a9e103a5d56f9ffa5ec}{00045} std::string \hyperlink{classAudioSource_aea5c3828f1b22a9e103a5d56f9ffa5ec}{AudioSource::Path}()\textcolor{keyword}{ const}
00046 \textcolor{keyword}{}\{
00047     assert(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} != \textcolor{keyword}{nullptr});
00048     assert(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context}->filename != \textcolor{keyword}{nullptr});
00049     \textcolor{keywordflow}{return} std::string(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context}->filename);
00050 \}
00051 
\hypertarget{audio__source_8cpp_source_l00052}{}\hyperlink{classAudioSource_a267178b39a3a4d2fc86f41f6a96caf03}{00052} std::uint8\_t \hyperlink{classAudioSource_a267178b39a3a4d2fc86f41f6a96caf03}{AudioSource::ChannelCount}()\textcolor{keyword}{ const}
00053 \textcolor{keyword}{}\{
00054     assert(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} != \textcolor{keyword}{nullptr});
00055     \textcolor{keywordflow}{return} this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context}->signal.channels;
00056 \}
00057 
\hypertarget{audio__source_8cpp_source_l00058}{}\hyperlink{classAudioSource_af63c7249c1cf8d4ef86274ea2fdc1f26}{00058} \textcolor{keywordtype}{size\_t} \hyperlink{classAudioSource_af63c7249c1cf8d4ef86274ea2fdc1f26}{AudioSource::BufferSampleCapacity}()\textcolor{keyword}{ const}
00059 \textcolor{keyword}{}\{
00060     \textcolor{keywordflow}{return} this->\hyperlink{classAudioSource_ad278f3b315e3ad91add683d5eda48a03}{buffer}.size() / this->\hyperlink{classAudioSource_ae6eb4d0fc3d1d60375edc2745b635818}{BytesPerSample}();
00061 \}
00062 
\hypertarget{audio__source_8cpp_source_l00063}{}\hyperlink{classAudioSource_aee0c4889919554f3c947a217f4436378}{00063} \textcolor{keywordtype}{double} \hyperlink{classAudioSource_aee0c4889919554f3c947a217f4436378}{AudioSource::SampleRate}()\textcolor{keyword}{ const}
00064 \textcolor{keyword}{}\{
00065     assert(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} != \textcolor{keyword}{nullptr});
00066     \textcolor{keywordflow}{return} this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context}->signal.rate;
00067 \}
00068 
\hypertarget{audio__source_8cpp_source_l00069}{}\hyperlink{classAudioSource_ac0a5d14505c36238d4a8a465122ff06e}{00069} std::uint64\_t \hyperlink{classAudioSource_ac0a5d14505c36238d4a8a465122ff06e}{AudioSource::SamplePositionFromMicroseconds}(
00070                 std::chrono::microseconds usec)\textcolor{keyword}{ const}
00071 \textcolor{keyword}{}\{
00072     \textcolor{comment}{// The sample rate is expressed in terms of samples per second, so we}
00073     \textcolor{comment}{// need to convert the position to seconds then multiply by the rate.}
00074     \textcolor{comment}{// We do things in a slightly peculiar order to minimise rounding.}
00075 
00076     \textcolor{keyword}{auto} sample\_micros = usec * \hyperlink{classAudioSource_aee0c4889919554f3c947a217f4436378}{SampleRate}();
00077     \textcolor{keywordflow}{return} std::chrono::duration\_cast<std::chrono::seconds>(sample\_micros)
00078                     .count();
00079 \}
00080 
\hypertarget{audio__source_8cpp_source_l00081}{}\hyperlink{classAudioSource_aa9c0d4b60adfc1470a560bbb8e66aaf8}{00081} std::chrono::microseconds \hyperlink{classAudioSource_aa9c0d4b60adfc1470a560bbb8e66aaf8}{AudioSource::MicrosecondPositionFromSamples}
      (
00082                 std::uint64\_t samples)\textcolor{keyword}{ const}
00083 \textcolor{keyword}{}\{
00084     \textcolor{comment}{// This is basically SamplePositionFromMicroseconds but backwards.}
00085 
00086     \textcolor{keyword}{auto} position\_secs = std::chrono::seconds(samples) / \hyperlink{classAudioSource_aee0c4889919554f3c947a217f4436378}{SampleRate}();
00087     \textcolor{keywordflow}{return} std::chrono::duration\_cast<std::chrono::microseconds>(
00088                     position\_secs);
00089 \}
00090 
\hypertarget{audio__source_8cpp_source_l00091}{}\hyperlink{classAudioSource_ae6eb4d0fc3d1d60375edc2745b635818}{00091} \textcolor{keywordtype}{size\_t} \hyperlink{classAudioSource_ae6eb4d0fc3d1d60375edc2745b635818}{AudioSource::BytesPerSample}()\textcolor{keyword}{ const}
00092 \textcolor{keyword}{}\{
00093     assert(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} != \textcolor{keyword}{nullptr});
00094 
00095     \textcolor{comment}{// Since libsox always outputs 32-bit samples, the bytes per sample is}
00096     \textcolor{comment}{// always 4 per channel.}
00097 
00098     \textcolor{comment}{// SoX has a slightly peculiar notion of sample counts, in that it}
00099     \textcolor{comment}{// regards each channel as having its own separate sample, so we need}
00100     \textcolor{comment}{// to multiply and divide sample counts by the channel count when}
00101     \textcolor{comment}{// talking to SoX.}
00102     \textcolor{keywordflow}{return} 4 * \hyperlink{classAudioSource_a267178b39a3a4d2fc86f41f6a96caf03}{ChannelCount}();
00103 \}
00104 
\hypertarget{audio__source_8cpp_source_l00105}{}\hyperlink{classAudioSource_ad8639603fb59d21f5c1369707f16975c}{00105} std::uint64\_t \hyperlink{classAudioSource_ad8639603fb59d21f5c1369707f16975c}{AudioSource::Seek}(std::chrono::microseconds position)
00106 \{
00107     assert(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} != \textcolor{keyword}{nullptr});
00108 
00109     \textcolor{keyword}{auto} samples = \hyperlink{classAudioSource_ac0a5d14505c36238d4a8a465122ff06e}{SamplePositionFromMicroseconds}(position);
00110 
00111     \textcolor{comment}{// See BytesPerSample() for an explanation of this ChannelCount().}
00112     \textcolor{keyword}{auto} sox\_samples = samples * \hyperlink{classAudioSource_a267178b39a3a4d2fc86f41f6a96caf03}{ChannelCount}();
00113 
00114     \textcolor{comment}{// libsox doesn't seem to like seeking into an ended file, so close}
00115     \textcolor{comment}{// and re-open it first.}
00116     \textcolor{keywordflow}{if} (this->\hyperlink{classAudioSource_abe3899ebe685335a84c5bfee5a20a96f}{decode\_state} == \hyperlink{classAudioSource_a9a2f5de44325c84e69a7af1331aa159da581953f6b20ad7f993b64b1dc632032e}{DecodeState::END\_OF\_FILE}) \{
00117         std::string path = \hyperlink{classAudioSource_aea5c3828f1b22a9e103a5d56f9ffa5ec}{Path}();
00118         \hyperlink{classAudioSource_a46444de950d02ac35a695ad167fed2f4}{Close}();
00119         \hyperlink{classAudioSource_a9b10234d7c9f29b17008b4dc3eab2a71}{Open}(path);
00120     \}
00121 
00122     \textcolor{keywordflow}{if} (sox\_seek(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context}, sox\_samples, SOX\_SEEK\_SET) != SOX\_SUCCESS) \{
00123         \textcolor{keywordflow}{throw} \hyperlink{classInternalError}{InternalError}(\hyperlink{messages_8h_aed3c894dfba47c4007dc39b38b5d3dbe}{MSG\_SEEK\_FAIL});
00124     \}
00125 
00126     \textcolor{comment}{// Reset the decoder state, because otherwise the decoder will get very}
00127     \textcolor{comment}{// confused.}
00128     this->\hyperlink{classAudioSource_abe3899ebe685335a84c5bfee5a20a96f}{decode\_state} = \hyperlink{classAudioSource_a9a2f5de44325c84e69a7af1331aa159da9b75f3acd3c3480965b0f5ee466e7f25}{DecodeState::DECODING};
00129 
00130     \textcolor{keywordflow}{return} samples;
00131 \}
00132 
\hypertarget{audio__source_8cpp_source_l00133}{}\hyperlink{classAudioSource_a6b5071168332523b68593bc47170f36f}{00133} \hyperlink{classAudioSource_aadbadeba50d982d09cfe0d1e05160ef9}{AudioSource::DecodeResult} \hyperlink{classAudioSource_a6b5071168332523b68593bc47170f36f}{AudioSource::Decode}()
00134 \{
00135     assert(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} != \textcolor{keyword}{nullptr});
00136 
00137     \textcolor{keyword}{auto} buf = \textcolor{keyword}{reinterpret\_cast<}sox\_sample\_t *\textcolor{keyword}{>}(&this->\hyperlink{classAudioSource_ad278f3b315e3ad91add683d5eda48a03}{buffer}.front());
00138 
00139     \textcolor{comment}{// See BytesPerSample() for an explanation of this ChannelCount().}
00140     \textcolor{keyword}{auto} sox\_capacity = \hyperlink{classAudioSource_af63c7249c1cf8d4ef86274ea2fdc1f26}{BufferSampleCapacity}() * 
      \hyperlink{classAudioSource_a267178b39a3a4d2fc86f41f6a96caf03}{ChannelCount}();
00141     \textcolor{keywordtype}{size\_t} read = sox\_read(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context}, buf, sox\_capacity);
00142 
00143     \hyperlink{classAudioSource_a836c61e348dbe7df6ba255669c015303}{DecodeVector} decoded;
00144 
00145     \textcolor{keywordflow}{if} (read == 0) \{
00146         this->\hyperlink{classAudioSource_abe3899ebe685335a84c5bfee5a20a96f}{decode\_state} = \hyperlink{classAudioSource_a9a2f5de44325c84e69a7af1331aa159da581953f6b20ad7f993b64b1dc632032e}{DecodeState::END\_OF\_FILE};
00147     \} \textcolor{keywordflow}{else} \{
00148         this->\hyperlink{classAudioSource_abe3899ebe685335a84c5bfee5a20a96f}{decode\_state} = \hyperlink{classAudioSource_a9a2f5de44325c84e69a7af1331aa159da9b75f3acd3c3480965b0f5ee466e7f25}{DecodeState::DECODING};
00149 
00150         \textcolor{comment}{// Copy only the bit of the buffer occupied by decoded data}
00151         \textcolor{comment}{// See BytesPerSample() for an explanation of the}
00152         \textcolor{comment}{// ChannelCount() division.}
00153         \textcolor{keyword}{auto} front = this->\hyperlink{classAudioSource_ad278f3b315e3ad91add683d5eda48a03}{buffer}.begin();
00154         \textcolor{keyword}{auto} read\_bytes = (\hyperlink{classAudioSource_ae6eb4d0fc3d1d60375edc2745b635818}{BytesPerSample}() * read) / \hyperlink{classAudioSource_a267178b39a3a4d2fc86f41f6a96caf03}{ChannelCount}();
00155         decoded = \hyperlink{classAudioSource_a836c61e348dbe7df6ba255669c015303}{DecodeVector}(front, front + read\_bytes);
00156     \}
00157 
00158     \textcolor{keywordflow}{return} std::make\_pair(this->\hyperlink{classAudioSource_abe3899ebe685335a84c5bfee5a20a96f}{decode\_state}, decoded);
00159 \}
00160 
\hypertarget{audio__source_8cpp_source_l00164}{}\hyperlink{classAudioSource_aa6c567c4e2f3c6673d2a289d84aedae0}{00164} \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772}{SampleFormat} \hyperlink{classAudioSource_aa6c567c4e2f3c6673d2a289d84aedae0}{AudioSource::OutputSampleFormat}()\textcolor{keyword}{ const}
00165 \textcolor{keyword}{}\{
00166     \textcolor{comment}{// 'The function sox\_read reads len samples in to buf using the format}
00167     \textcolor{comment}{// handler specified by ft. All data read is converted to 32-bit signed}
00168     \textcolor{comment}{// samples before being placed in to buf.'}
00169     \textcolor{keywordflow}{return} \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772ae222eded89afdf8cf763bb1a58a04fc0}{SampleFormat::PACKED\_SIGNED\_INT\_32};
00170 \}
00171 
\hypertarget{audio__source_8cpp_source_l00172}{}\hyperlink{classAudioSource_a9b10234d7c9f29b17008b4dc3eab2a71}{00172} \textcolor{keywordtype}{void} \hyperlink{classAudioSource_a9b10234d7c9f29b17008b4dc3eab2a71}{AudioSource::Open}(\textcolor{keyword}{const} std::string &path)
00173 \{
00174     \hyperlink{classAudioSource_a46444de950d02ac35a695ad167fed2f4}{Close}();
00175 
00176     this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} = sox\_open\_read(path.c\_str(), \textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr});
00177     \textcolor{keywordflow}{if} (this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} == \textcolor{keyword}{nullptr}) \{
00178         std::ostringstream os;
00179         os << \textcolor{stringliteral}{"couldn't open "} << path;
00180         \textcolor{keywordflow}{throw} \hyperlink{classFileError}{FileError}(os.str());
00181     \}
00182 \}
00183 
\hypertarget{audio__source_8cpp_source_l00184}{}\hyperlink{classAudioSource_a46444de950d02ac35a695ad167fed2f4}{00184} \textcolor{keywordtype}{void} \hyperlink{classAudioSource_a46444de950d02ac35a695ad167fed2f4}{AudioSource::Close}()
00185 \{
00186     \textcolor{keywordflow}{if} (this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} != \textcolor{keyword}{nullptr}) \{
00187         sox\_close(this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context});
00188         this->\hyperlink{classAudioSource_a2bbce89d4bef9cf46b1113de3245655a}{context} = \textcolor{keyword}{nullptr};
00189     \}
00190 \}
\end{DoxyCode}
