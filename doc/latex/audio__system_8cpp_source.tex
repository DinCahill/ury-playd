\hypertarget{audio__system_8cpp_source}{\section{audio\+\_\+system.\+cpp}
\label{audio__system_8cpp_source}\index{src/audio/audio\+\_\+system.\+cpp@{src/audio/audio\+\_\+system.\+cpp}}
}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of playd.}
00002 \textcolor{comment}{// playd is licenced under the MIT license: see LICENSE.txt.}
00003 
00010 \textcolor{preprocessor}{#include <algorithm>}
00011 \textcolor{preprocessor}{#include <map>}
00012 \textcolor{preprocessor}{#include <sstream>}
00013 \textcolor{preprocessor}{#include <stdexcept>}
00014 \textcolor{preprocessor}{#include <string>}
00015 
00016 \textcolor{keyword}{extern} \textcolor{stringliteral}{"C"} \{
00017 \textcolor{preprocessor}{#include <sox.h>}
00018 \textcolor{preprocessor}{#include "portaudio.h"}
00019 \}
00020 
00021 \textcolor{preprocessor}{#include "portaudiocpp/Device.hxx"}
00022 \textcolor{preprocessor}{#include "portaudiocpp/DirectionSpecificStreamParameters.hxx"}
00023 \textcolor{preprocessor}{#include "portaudiocpp/InterfaceCallbackStream.hxx"}
00024 \textcolor{preprocessor}{#include "portaudiocpp/SampleDataFormat.hxx"}
00025 \textcolor{preprocessor}{#include "portaudiocpp/Stream.hxx"}
00026 \textcolor{preprocessor}{#include "portaudiocpp/StreamParameters.hxx"}
00027 \textcolor{preprocessor}{#include "portaudiocpp/System.hxx"}
00028 \textcolor{preprocessor}{#include "portaudiocpp/SystemDeviceIterator.hxx"}
00029 \textcolor{keyword}{namespace }portaudio \{
00030 \textcolor{keyword}{class }CallbackInterface;
00031 \}
00032 
00033 \textcolor{preprocessor}{#include "../errors.hpp"}
00034 \textcolor{preprocessor}{#include "../messages.h"}
00035 \textcolor{preprocessor}{#include "../sample\_formats.hpp"}
00036 \textcolor{preprocessor}{#include "\hyperlink{audio_8hpp}{audio.hpp}"}
00037 \textcolor{preprocessor}{#include "\hyperlink{audio__sink_8hpp}{audio\_sink.hpp}"}
00038 \textcolor{preprocessor}{#include "\hyperlink{audio__source_8hpp}{audio\_source.hpp}"}
00039 \textcolor{preprocessor}{#include "\hyperlink{audio__system_8hpp}{audio\_system.hpp}"}
00040 
\hypertarget{audio__system_8cpp_source_l00041}{}\hyperlink{classAudioSystem_ad17cde8deff07ef7d7d56be62df98739}{00041} \hyperlink{classAudioSystem_ad17cde8deff07ef7d7d56be62df98739}{AudioSystem::AudioSystem}()
00042 \{
00043     portaudio::System::initialize();
00044     sox\_format\_init();
00045 
00046     this->\hyperlink{classAudioSystem_a3071e6d8643b3d0275ba63820e6e0072}{device\_id} = -1;
00047 \}
00048 
\hypertarget{audio__system_8cpp_source_l00049}{}\hyperlink{classAudioSystem_a9ad830040ea5f68a6a63957c6f281055}{00049} \hyperlink{classAudioSystem_a9ad830040ea5f68a6a63957c6f281055}{AudioSystem::~AudioSystem}()
00050 \{
00051     portaudio::System::terminate();
00052     sox\_format\_quit();
00053 \}
00054 
\hypertarget{audio__system_8cpp_source_l00055}{}\hyperlink{classAudioSystem_aa268faeb9243c18588631024958856e6}{00055} std::vector<AudioSystem::Device> \hyperlink{classAudioSystem_aa268faeb9243c18588631024958856e6}{AudioSystem::GetDevicesInfo}()
00056 \{
00057     \textcolor{keyword}{auto} &pa = portaudio::System::instance();
00058     std::vector<AudioSystem::Device> list;
00059 
00060     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} d = pa.devicesBegin(); d != pa.devicesEnd(); ++d) \{
00061         \textcolor{keywordflow}{if} (!(*d).isInputOnlyDevice()) \{
00062             list.push\_back(std::make\_pair((*d).index(),
00063                                           (*d).name()));
00064         \}
00065     \}
00066     \textcolor{keywordflow}{return} list;
00067 \}
00068 
\hypertarget{audio__system_8cpp_source_l00069}{}\hyperlink{classAudioSystem_a001cd82f854883b80b3ed7d35795581b}{00069} \textcolor{keywordtype}{bool} \hyperlink{classAudioSystem_a001cd82f854883b80b3ed7d35795581b}{AudioSystem::IsOutputDevice}(\textcolor{keywordtype}{int} \textcolor{keywordtype}{id})
00070 \{
00071     \textcolor{keyword}{auto} &pa = portaudio::System::instance();
00072     \textcolor{keywordflow}{if} (id < 0 || id >= pa.deviceCount()) \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00073 
00074     portaudio::Device &dev = pa.deviceByIndex(\textcolor{keywordtype}{id});
00075     \textcolor{keywordflow}{return} !dev.isInputOnlyDevice();
00076 \}
00077 
\hypertarget{audio__system_8cpp_source_l00078}{}\hyperlink{classAudioSystem_ade3b400828991d02e36a0b61302d30d2}{00078} \textcolor{keywordtype}{void} \hyperlink{classAudioSystem_ade3b400828991d02e36a0b61302d30d2}{AudioSystem::SetDeviceID}(\textcolor{keywordtype}{int} \textcolor{keywordtype}{id})
00079 \{
00080     this->\hyperlink{classAudioSystem_a3071e6d8643b3d0275ba63820e6e0072}{device\_id} = std::to\_string(\textcolor{keywordtype}{id});
00081 \}
00082 
\hypertarget{audio__system_8cpp_source_l00083}{}\hyperlink{classAudioSystem_a2172608177d2bd54377bfc3c61cd117d}{00083} \hyperlink{classAudio}{Audio} *\hyperlink{classAudioSystem_a2172608177d2bd54377bfc3c61cd117d}{AudioSystem::Load}(\textcolor{keyword}{const} std::string &path)\textcolor{keyword}{ const}
00084 \textcolor{keyword}{}\{
00085     \textcolor{keyword}{auto} source = \textcolor{keyword}{new} \hyperlink{classAudioSource}{AudioSource}(path);
00086 
00087     \hyperlink{classAudioSink_ae5b8370aa17c24c6fc8f8e0c5778168c}{AudioSink::StreamConfigurator} config\_fn = std::bind(
00088                     &\hyperlink{classAudioSystem_a78e8754440e0a29f5fac9ca1cd79a109}{AudioSystem::Configure}, \textcolor{keyword}{this}, source->ChannelCount(),
00089                     source->OutputSampleFormat(), source->SampleRate(),
00090                     source->BufferSampleCapacity(), std::placeholders::\_1);
00091     \textcolor{keyword}{auto} sink = \textcolor{keyword}{new} \hyperlink{classAudioSink}{AudioSink}(config\_fn, source->BytesPerSample());
00092 
00093     \textcolor{keywordflow}{return} \textcolor{keyword}{new} \hyperlink{classAudio}{Audio}(source, sink);
00094 \}
00095 
\hypertarget{audio__system_8cpp_source_l00096}{}\hyperlink{classAudioSystem_a78e8754440e0a29f5fac9ca1cd79a109}{00096} portaudio::Stream *\hyperlink{classAudioSystem_a78e8754440e0a29f5fac9ca1cd79a109}{AudioSystem::Configure}(
00097                 std::uint8\_t channel\_count, \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772}{SampleFormat} sample\_format,
00098                 \textcolor{keywordtype}{double} sample\_rate, \textcolor{keywordtype}{size\_t} buffer\_size,
00099                 portaudio::CallbackInterface &cb)\textcolor{keyword}{ const}
00100 \textcolor{keyword}{}\{
00101     \textcolor{keyword}{const} portaudio::Device &device = \hyperlink{classAudioSystem_a513a0de4748574e25cba443f28949a90}{PaDeviceFrom}(this->\hyperlink{classAudioSystem_a3071e6d8643b3d0275ba63820e6e0072}{device\_id});
00102 
00103     portaudio::DirectionSpecificStreamParameters out\_pars(
00104                     device, channel\_count,
00105                     \hyperlink{classAudioSystem_aac640b14ad80c2518539bcafe9f4b5ac}{PaSampleFormatFrom}(sample\_format), \textcolor{keyword}{true},
00106                     device.defaultLowOutputLatency(), \textcolor{keyword}{nullptr});
00107 
00108     portaudio::StreamParameters pars(
00109                     portaudio::DirectionSpecificStreamParameters::null(),
00110                     out\_pars, sample\_rate, buffer\_size, paClipOff);
00111 
00112     \textcolor{keywordflow}{return} \textcolor{keyword}{new} portaudio::InterfaceCallbackStream(pars, cb);
00113 \}
00114 
\hypertarget{audio__system_8cpp_source_l00115}{}\hyperlink{classAudioSystem_a513a0de4748574e25cba443f28949a90}{00115} \textcolor{keyword}{const} portaudio::Device &\hyperlink{classAudioSystem_a513a0de4748574e25cba443f28949a90}{AudioSystem::PaDeviceFrom}(\textcolor{keyword}{const} std::string &id\_string)\textcolor{keyword}{}
00116 \textcolor{keyword}{                const}
00117 \textcolor{keyword}{}\{
00118     \textcolor{keyword}{auto} &pa = portaudio::System::instance();
00119 
00120     PaDeviceIndex id\_pa = 0;
00121 
00122     std::istringstream is(id\_string);
00123     is >> id\_pa;
00124 
00125     \textcolor{keywordflow}{if} (id\_pa >= pa.deviceCount()) \{
00126         \textcolor{keywordflow}{throw} \hyperlink{classConfigError}{ConfigError}(\hyperlink{messages_8h_a80a8cb0d00a63114c8c5c8228fa39ec4}{MSG\_DEV\_BADID});
00127     \}
00128 
00129     \textcolor{keywordflow}{return} pa.deviceByIndex(id\_pa);
00130 \}
00131 
00133 \textcolor{keyword}{static} \textcolor{keyword}{const} std::map<SampleFormat, portaudio::SampleDataFormat> pa\_from\_sf = \{
00134     \{ \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772a0f083be5e0e503eb0830e26687f00cf2}{SampleFormat::PACKED\_UNSIGNED\_INT\_8}, portaudio::UINT8 \},
00135     \{ \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772a3bc6c5371607364846832278d3d39965}{SampleFormat::PACKED\_SIGNED\_INT\_16}, portaudio::INT16 \},
00136     \{ \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772ae222eded89afdf8cf763bb1a58a04fc0}{SampleFormat::PACKED\_SIGNED\_INT\_32}, portaudio::INT32 \},
00137     \{ \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772ae58d6feb65720ac0b7e1158a2debcf7d}{SampleFormat::PACKED\_FLOAT\_32}, portaudio::FLOAT32 \}
00138 \};
00139 
\hypertarget{audio__system_8cpp_source_l00140}{}\hyperlink{classAudioSystem_aac640b14ad80c2518539bcafe9f4b5ac}{00140} portaudio::SampleDataFormat \hyperlink{classAudioSystem_aac640b14ad80c2518539bcafe9f4b5ac}{AudioSystem::PaSampleFormatFrom}(
      \hyperlink{sample__formats_8hpp_a21cca244e782ff3acc8805fb73236772}{SampleFormat} fmt)\textcolor{keyword}{}
00141 \textcolor{keyword}{                const}
00142 \textcolor{keyword}{}\{
00143     \textcolor{keywordflow}{try}
00144     \{
00145         \textcolor{keywordflow}{return} pa\_from\_sf.at(fmt);
00146     \}
00147     \textcolor{keywordflow}{catch} (std::out\_of\_range)
00148     \{
00149         \textcolor{keywordflow}{throw} \hyperlink{classFileError}{FileError}(\hyperlink{messages_8h_a6d4302117e822520f5c61b6d40085c4d}{MSG\_DECODE\_BADRATE});
00150     \}
00151 \}
\end{DoxyCode}
